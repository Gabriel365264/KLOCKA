<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klocka_Audio_Workaround</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap');

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Noto Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    :root {
      --ikea-blue: #0051BA;
      --ikea-blue-dark: #00337a;
      --header-grey: #555555;
      --bg-light: #f5f5f5;
      --panel-bg: #ffffff;
      --accent-green: #00c853;
      --accent-red: #ff1744;
      --accent-pink: #ff8aa7;
      --accent-add: #ff80ab;
      --config-pill: #c5b7ff;
      --text-main: #111111;
      --text-muted: #555555;
      --border-color: #e0e0e0;
    }

    body {
      background: var(--bg-light);
      color: var(--text-main);
      line-height: 1.5;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: var(--ikea-blue-dark);
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .app-title {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      background: #ffffff33;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }
    .header-button:hover {
        background: #ffffff55;
    }
    #btnFullscreen { font-size: 1.1rem; }
    #btnToConfig { background: var(--config-pill); }

    .app-main {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .hidden { display: none !important; }

    .config-layout {
      display: flex;
      gap: 40px;
      align-items: flex-start;
    }

    .config-left { flex: 2; }
    .config-right { flex: 1; }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: filter 0.2s;
    }
    .btn:hover { filter: brightness(1.1); }
    .btn:disabled { background: #a5d6a7; cursor: default; filter: none; }

    .btn-add {
      background: var(--accent-add);
      color: #fff;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--accent-green);
      color: #fff;
      width: 100%;
      font-size: 1.05rem;
      padding: 14px 24px;
    }

    .info-box {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .info-box p + p { margin-top: 10px; }
    .info-box .btn-primary { margin-top: 24px; }

    .product-list {
      background: var(--panel-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .product-row {
      display: grid;
      grid-template-columns: 32px minmax(0, 1.4fr) 40px 70px 16px 70px;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
    }
    .product-list > .product-row:last-child { border-bottom: none; }

    .product-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .product-name-input, .time-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .time-input { text-align: center; -moz-appearance: textfield; }
    .time-input::-webkit-outer-spin-button, .time-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .time-separator { text-align: center; font-weight: 600; }
    .delete-btn {
      background: none; border: none; color: var(--accent-red);
      font-size: 1.4rem; line-height: 1; cursor: pointer;
    }
    .delete-btn:hover { color: #c00; }

    .timer-container {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 8px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .timer-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 120px 120px;
      gap: 12px;
      align-items: center;
      padding: 8px 16px;
    }
    .timer-row + .timer-row { border-top: 1px solid var(--border-color); }

    .timer-bar { position: relative; width: 100%; height: 44px; overflow: hidden; }
    .timer-bar-fill {
      position: absolute; left: 0; top: 0; bottom: 0; width: 0;
      background: var(--accent-pink);
      transition: width 0.4s linear;
    }
    .timer-bar-fill.expired {
      background: var(--accent-red);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .timer-bar-content {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      height: 100%;
    }
    .timer-name { font-weight: 600; font-size: 1rem; }
    .timer-time { font-size: 1.1rem; font-weight: 600; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .btn-start { background: #f5f5f5; color: var(--accent-green); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-stop { background: var(--accent-red); color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
    .btn-start, .btn-stop { border-radius: 12px; padding: 10px 18px; font-weight: 600; font-size: 0.95rem; }

    @media (max-width: 900px) {
      .config-layout { flex-direction: column; }
    }
    @media (max-width: 600px) {
      .app-main { padding: 16px; }
      .app-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .timer-row {
        grid-template-columns: 1fr 1fr;
        grid-template-areas: "bar bar" "start stop";
        gap: 8px;
        padding-inline: 8px;
      }
      .timer-bar { grid-area: bar; }
      .timer-row .btn-start { grid-area: start; }
      .timer-row .btn-stop { grid-area: stop; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-title" id="appTitle">Klocka</div>
    <div class="header-right">
      <button class="header-button" id="btnLanguage">üá©üá™ / EN</button>
      <button class="header-button" id="btnFullscreen" aria-label="Toggle Fullscreen">‚õ∂</button>
      <button class="header-button hidden" id="btnToConfig">Zeit einstellen ‚è±</button>
    </div>
  </header>

  <main class="app-main">
    <section id="configView">
      <div class="config-layout">
        <div class="config-left">
          <button class="btn btn-add" id="btnAddProduct">Produkt hinzuf√ºgen</button>
          <div class="product-list" id="productList"></div>
        </div>
        <div class="config-right">
          <div class="info-box">
            <p id="infoText1">Hier kannst du die Haltezeiten einstellen.</p>
            <p id="infoText2">Neue Produkte kannst du in die freien Felder eintragen.</p>
            <button class="btn btn-primary" id="btnToTimer">Wenn du fertig bist, klicke hier</button>
          </div>
        </div>
      </div>
    </section>

    <section id="timerView" class="hidden">
      <div class="timer-container" id="timerList"></div>
    </section>
  </main>

  <audio id="keepAliveAudio" loop src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjM2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU2LjQxAAAAAAAAAAAAAAAAJAAAAAAAAAAAASDs90hvAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAAAAAAAA0gAAAAATEFN//MUZAMAAAGkAAAAAAAAA0gAAAAARTMu//MUZAYAAAGkAAAAAAAAA0gAAAAA//MUZAgAAAGkAAAAAAAAA0gAAAAA"></audio>

  <script>
    const DEFAULT_PRODUCTS = [
      { name: "Veggie Dog", h: 0, m: 20, active: true },
      { name: "Plant Dog", h: 0, m: 20, active: true },
      { name: "Gefl√ºgel Dog", h: 0, m: 50, active: true },
      { name: "Plant Nuggets", h: 0, m: 30, active: true },
      { name: "K√∂ttbullar", h: 0, m: 40, active: true },
      { name: "Zimtschnecken", h: 2, m: 0, active: true },
      { name: "Muffin Schoko", h: 12, m: 0, active: true },
      { name: "Muffin Blaubeer", h: 12, m: 0, active: true }
    ];
    const STORAGE_KEYS = { products: 'klockaProducts', timers: 'klockaTimers', lang: 'klockaLang' };
    const I18N = {
      de: {
        title: 'Klocka', addProduct: 'Produkt hinzuf√ºgen',
        info1: 'Hier kannst du die Haltezeiten einstellen.',
        info2: 'Neue Produkte kannst du in die freien Felder eintragen.',
        ready: "Wenn du fertig bist, klicke hier", setTime: 'Zeit einstellen ‚è±',
        start: 'Start', stop: 'Stop',
        noProducts: 'Keine aktiven Produkte. Bitte unter "Zeit einstellen" konfigurieren.',
        deleteProduct: 'Produkt l√∂schen', productName: 'Produktname',
        hours: 'Stunden', minutes: 'Minuten', activateProduct: 'Produkt aktivieren'
      },
      en: {
        title: 'Klocka', addProduct: 'Add product',
        info1: 'Here you can set the holding times.',
        info2: 'You can enter new products into the empty fields.',
        ready: "When you're finished, click here", setTime: 'Set time ‚è±',
        start: 'Start', stop: 'Stop',
        noProducts: 'No active products. Please configure under "Set time".',
        deleteProduct: 'Delete product', productName: 'Product name',
        hours: 'Hours', minutes: 'Minutes', activateProduct: 'Activate product'
      }
    };
    let currentLang = localStorage.getItem(STORAGE_KEYS.lang) || 'de';
    let products = [];
    let nextId = 1;
    let timers = {};
    const DOM = {
        configView: document.getElementById('configView'),
        timerView: document.getElementById('timerView'),
        btnToConfig: document.getElementById('btnToConfig'),
        body: document.body
    };

    document.addEventListener('DOMContentLoaded', init);

    function init() {
        loadProducts();
        loadTimers();
        applyLanguage();
        renderConfigView();
        renderTimerView();
        setupEventListeners();
        startUpdateLoop();
    }

    function loadProducts() {
        try {
            const stored = localStorage.getItem(STORAGE_KEYS.products);
            products = stored ? JSON.parse(stored) : DEFAULT_PRODUCTS.map((p, i) => ({ id: i + 1, ...p }));
        } catch {
            products = DEFAULT_PRODUCTS.map((p, i) => ({ id: i + 1, ...p }));
        }
        nextId = products.reduce((maxId, p) => Math.max(p.id, maxId), 0) + 1;
    }
    function saveProducts() { localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(products)); }

    function loadTimers() {
        try {
            const stored = JSON.parse(localStorage.getItem(STORAGE_KEYS.timers) || '{}');
            const now = Date.now();
            for (const id in stored) {
                const t = stored[id];
                if (t.running && t.endTimeMs) {
                    const remaining = Math.max(0, t.endTimeMs - now);
                    timers[id] = { ...t, remainingMs: remaining, running: remaining > 0, endTimeMs: remaining > 0 ? t.endTimeMs : null };
                } else {
                    timers[id] = { ...t, running: false, endTimeMs: null };
                }
            }
        } catch { timers = {}; }
    }
    function saveTimers() { localStorage.setItem(STORAGE_KEYS.timers, JSON.stringify(timers)); }

    function setupEventListeners() {
        document.getElementById('btnAddProduct').addEventListener('click', addProduct);
        document.getElementById('btnToTimer').addEventListener('click', () => setView('timer'));
        document.getElementById('btnToConfig').addEventListener('click', () => setView('config'));
        document.getElementById('btnLanguage').addEventListener('click', toggleLanguage);
        document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);

        document.getElementById('productList').addEventListener('change', handleConfigChange);
        document.getElementById('productList').addEventListener('click', handleConfigClick);
        document.getElementById('timerList').addEventListener('click', handleTimerClick);

        window.addEventListener('beforeunload', saveTimers);
        document.addEventListener('fullscreenchange', handleFullscreenChange);
    }
    
    function setView(viewName) {
        const isTimerView = viewName === 'timer';
        DOM.configView.classList.toggle('hidden', isTimerView);
        DOM.timerView.classList.toggle('hidden', !isTimerView);
        DOM.btnToConfig.classList.toggle('hidden', !isTimerView);
        DOM.body.classList.toggle('timer-mode', isTimerView);
    }

    function applyLanguage() {
        const t = I18N[currentLang];
        document.documentElement.lang = currentLang;
        document.getElementById('appTitle').textContent = t.title;
        document.getElementById('btnAddProduct').textContent = t.addProduct;
        document.getElementById('infoText1').textContent = t.info1;
        document.getElementById('infoText2').textContent = t.info2;
        document.getElementById('btnToTimer').textContent = t.ready;
        document.getElementById('btnToConfig').textContent = t.setTime;
        document.getElementById('btnLanguage').textContent = currentLang === 'de' ? 'üá©üá™ / EN' : 'DE / üá¨üáß';
    }

    function renderConfigView() {
        const t = I18N[currentLang];
        const container = document.getElementById('productList');
        container.innerHTML = products.map(p => `
            <div class="product-row" data-id="${p.id}">
              <input type="checkbox" ${p.active ? 'checked' : ''} aria-label="${t.activateProduct}">
              <input type="text" class="product-name-input" value="${p.name || ''}" placeholder="${t.productName}" aria-label="${t.productName}">
              <button class="delete-btn" aria-label="${t.deleteProduct}">&times;</button>
              <input type="number" class="time-input hours" value="${p.h || 0}" min="0" max="99" aria-label="${t.hours}">
              <div class="time-separator">:</div>
              <input type="number" class="time-input minutes" value="${p.m || 0}" min="0" max="59" aria-label="${t.minutes}">
            </div>
        `).join('');
    }

    function renderTimerView() {
        const t = I18N[currentLang];
        const container = document.getElementById('timerList');
        const activeProducts = products.filter(p => p.active && (p.name || '').trim() !== '');

        if (activeProducts.length === 0) {
            container.innerHTML = `<p style="padding: 16px;">${t.noProducts}</p>`;
            return;
        }

        container.innerHTML = activeProducts.map(p => {
            const totalMs = (Number(p.h || 0) * 3600 + Number(p.m || 0) * 60) * 1000;
            if (!timers[p.id] || (!timers[p.id].running && timers[p.id].totalMs !== totalMs)) {
                timers[p.id] = { totalMs, remainingMs: totalMs, running: false, endTimeMs: null };
            }
            const timer = timers[p.id];
            const timeStr = formatDuration(timer.remainingMs);
            const fillWidth = timer.totalMs > 0 ? (timer.totalMs - timer.remainingMs) / timer.totalMs * 100 : 0;
            const isExpired = timer.remainingMs <= 0 && timer.totalMs > 0;
            
            return `
            <div class="timer-row" data-id="${p.id}">
              <div class="timer-bar">
                <div class="timer-bar-fill ${isExpired ? 'expired' : ''}" style="width: ${fillWidth}%"></div>
                <div class="timer-bar-content">
                  <span class="timer-name">${p.name}</span>
                  <span class="timer-time">${timeStr}</span>
                </div>
              </div>
              <button class="btn btn-start">${t.start}</button>
              <button class="btn btn-stop">${t.stop}</button>
            </div>`;
        }).join('');
    }

    function startUpdateLoop() {
        setInterval(() => {
            const now = Date.now();
            let needsRender = false;
            for (const id in timers) {
                const timer = timers[id];
                if (timer.running && timer.endTimeMs) {
                    const oldRemaining = timer.remainingMs;
                    timer.remainingMs = Math.max(0, timer.endTimeMs - now);
                    if (timer.remainingMs <= 0 && oldRemaining > 0) {
                        timer.running = false;
                        timer.endTimeMs = null;
                        saveTimers();
                        needsRender = true;
                    }
                    const row = document.querySelector(`.timer-row[data-id="${id}"]`);
                    if(row) updateRowUI(row, timer);
                }
            }
            if(needsRender) renderTimerView();
        }, 500);
    }
    
    function updateRowUI(row, timer) {
        row.querySelector('.timer-time').textContent = formatDuration(timer.remainingMs);
        const fill = row.querySelector('.timer-bar-fill');
        const fillWidth = timer.totalMs > 0 ? Math.min(100, (timer.totalMs - timer.remainingMs) / timer.totalMs * 100) : 0;
        fill.style.width = `${fillWidth}%`;
        fill.classList.toggle('expired', timer.remainingMs <= 0 && timer.totalMs > 0);
    }

    function addProduct() {
        products.push({ id: nextId++, name: '', h: 0, m: 0, active: true });
        saveProducts();
        renderConfigView();
        renderTimerView();
    }
    
    function toggleLanguage() {
        currentLang = currentLang === 'de' ? 'en' : 'de';
        localStorage.setItem(STORAGE_KEYS.lang, currentLang);
        applyLanguage();
        renderConfigView();
        renderTimerView();
    }
    
    function handleConfigChange(event) {
        const input = event.target;
        const row = input.closest('.product-row');
        if (!row) return;
        const id = Number(row.dataset.id);
        const p = products.find(x => x.id === id);
        if (!p) return;

        if (input.type === 'checkbox') p.active = input.checked;
        else if (input.classList.contains('product-name-input')) p.name = input.value;
        else if (input.classList.contains('hours')) p.h = clampInt(input.value, 0, 99);
        else if (input.classList.contains('minutes')) p.m = clampInt(input.value, 0, 59);
        
        saveProducts();
        if (input.type === 'number') updateTimerTotal(id);
        renderTimerView();
    }
    
    function handleConfigClick(event) {
        if (!event.target.matches('.delete-btn')) return;
        const row = event.target.closest('.product-row');
        if (!row) return;
        const id = Number(row.dataset.id);
        products = products.filter(x => x.id !== id);
        delete timers[id];
        saveProducts();
        saveTimers();
        renderConfigView();
        renderTimerView();
    }
    
    function handleTimerClick(event) {
        const btn = event.target;
        const row = btn.closest('.timer-row');
        if (!row) return;
        const id = Number(row.dataset.id);
        
        if (btn.matches('.btn-start')) startTimer(id);
        else if (btn.matches('.btn-stop')) stopTimer(id);
    }

    function startTimer(id) {
        const timer = timers[id];
        if (!timer) return;
        timer.running = true;
        timer.remainingMs = timer.totalMs;
        timer.endTimeMs = Date.now() + timer.remainingMs;
        saveTimers();
        renderTimerView();
    }

    function stopTimer(id) {
        const timer = timers[id];
        if (!timer) return;
        timer.running = false;
        timer.remainingMs = timer.totalMs;
        timer.endTimeMs = null;
        saveTimers();
        renderTimerView();
    }
    
    function updateTimerTotal(id) {
        const p = products.find(x => x.id === id);
        if (!p || !timers[id]) return;
        const newTotalMs = (Number(p.h || 0) * 3600 + Number(p.m || 0) * 60) * 1000;
        timers[id].totalMs = newTotalMs;
        if (!timers[id].running) timers[id].remainingMs = newTotalMs;
        saveTimers();
    }

    function formatDuration(ms) {
        if (ms <= 0) return '00:00:00';
        const totalSeconds = Math.ceil(ms / 1000);
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = totalSeconds % 60;
        return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }
    function clampInt(v, min, max) { return Math.max(min, Math.min(parseInt(v, 10) || 0, max)); }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`Fullscreen error: ${err.message}`));
        } else {
            document.exitFullscreen();
        }
    }
    function handleFullscreenChange() {
        const audio = document.getElementById('keepAliveAudio');
        if (document.fullscreenElement) audio.play().catch(e => console.warn("Audio keep-alive failed.", e));
        else audio.pause();
    }
  </script>
</body>
</html>
